<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <title>ChatGPT</title>
  <link rel="stylesheet" href="index.css" />
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/split.js/1.6.0/split.min.js"></script>
</head>

<body class="myarrow">
  <div class="flex">
    <div id="one" class="split page darwin">
      <webview id="webviewOAI" src="https://chat.openai.com/chat" autosize="on">
      </webview>
    </div>
    <div id="two" class="split page darwin">
      <webview id="webviewBARD" src="https://bard.google.com" autosize="on">
      </webview>
    </div>
    <div id="three" class="split page darwin">
      <webview id="webviewCLAUDE" src="https://console.anthropic.com/chat/new"
        autosize="on">
      </webview>
    </div>
  </div>
  <form id="form" class="">
    <textarea rows="4" id="prompt" name="prompt" autofocus
      placeholder="Enter a superprompt here (Cmd/Ctrl+Enter to Submit, Cmd+1/2/3/A/-/+ to resize windows, Cmd+R for new chat)"></textarea>
    <button id="btn" type="submit">Cmd+Enter to Submit</button>
  </form>
  <script>
    const Store = require('electron-store');
    const store = new Store();

    /** Current providers */
    const { Bard, Oai, Claude } = require('./providers.js');
    const bard = new Bard();
    const oai = new Oai();
    const claude = new Claude();

    const webviewOAI = document.getElementById('webviewOAI');
    const webviewBARD = document.getElementById('webviewBARD');
    const webviewCLAUDE = document.getElementById('webviewCLAUDE');

    // add event listener for btn
    const promptEl = document.getElementById('prompt');
    // Submit prompt when the user presses Enter or Ctrl+Enter in the textarea input
    const SuperPromptEnterKey = store.get('SuperPromptEnterKey', false);
    promptEl.addEventListener("keydown", function (event) {
      if (SuperPromptEnterKey) {
        if (event.keyCode === 13) {
          document.getElementById('btn').click();
        } else {
          if (event.keyCode === 13 && (event.metaKey || event.ctrlKey)) {
            document.getElementById('btn').click();
          }
        }
      }
    });

    /**
     * Simulates user input by executing a provider-specific
     * handler function for the given provider's webview context (DOM).
     */
    function simulateUserInput(webview, handler) {
      webview.executeJavaScript(`(${handler})();`);
    }

    /**
     * Simulates user input by executing a function in each provider's webview
     * context (DOM).
     *
     * Removes quotes and newlines from the input to avoid breaking the
     * executeJavaScript call.
     */
    promptEl.addEventListener('input', function (event) {
      const sanitizedInput = promptEl.value.replace(/"/g, '\\"').replace(/\n/g, '\\n');

      try {
        simulateUserInput(webviewBARD, bard.getInputHandler(sanitizedInput));
        simulateUserInput(webviewOAI, oai.getInputHandler(sanitizedInput));
        simulateUserInput(webviewCLAUDE, claude.getInputHandler(sanitizedInput));
      } catch (err) {
        console.error('Error simulating user input:', err);
      }
    });

    const form = document.getElementById('form');

    /** Submit superprompt on Cmd/Ctrl+Enter */
    promptEl.addEventListener("keydown", function (event) {
      const isCmdOrCtrl = event.metaKey || event.ctrlKey;
      if (isCmdOrCtrl && event.key === "Enter") {
        event.preventDefault();
        form.dispatchEvent(new Event("submit"));
      }
    });

    /** Submit superprompt to each provider's webview */
    form.addEventListener('submit', function (event) {
      const sanitizedInput = promptEl.value.replace(/"/g, '\\"').replace(/\n/g, '\\n');
      promptEl.value = "";
      event.preventDefault();

      webviewBARD.executeJavaScript(bard.getSubmitHandler(sanitizedInput));
      webviewOAI.executeJavaScript(oai.getSubmitHandler(sanitizedInput));
      webviewCLAUDE.executeJavaScript(claude.getSubmitHandler(sanitizedInput));
    });

    /**
   * Applies provider-specific CSS to the DOM of the given provider's webview.
   */
    function applyProviderStyles(webview, css) {
      webview.insertCSS(css);
    }

    webviewBARD.addEventListener('dom-ready', function () {
      applyProviderStyles(webviewBARD, bard.getDomReadyCss());
    });

    webviewOAI.addEventListener('dom-ready', function () {
      applyProviderStyles(webviewOAI, oai.getDomReadyCss());
    });

    webviewCLAUDE.addEventListener('dom-ready', function () {
      setTimeout(() => {
        applyProviderStyles(webviewCLAUDE, claude.getDomReadyCss());
      }, 1000);
    });

    const splitInstance = Split(["#one", "#two", "#three"], {
      direction: "horizontal",
      minSize: 0,
    });

    window.addEventListener('DOMContentLoaded', () => {
      updateSplitSizes();
    });

    function updateSplitSizes() {
      const webviewOAIEnabled = store.get('webviewOAIEnabled', true);
      const webviewBARDEnabled = store.get('webviewBARDEnabled', true);
      const webviewCLAUDEEnabled = store.get('webviewCLAUDEEnabled', true);

      const sizes = [
        webviewOAIEnabled ? 33.33 : 0,
        webviewBARDEnabled ? 33.33 : 0,
        webviewCLAUDEEnabled ? 33.33 : 0,
      ];

      const total = sizes.reduce((a, b) => a + b, 0);
      const normalizedSizes = sizes.map(size => (total === 0 ? 33.33 : (size / total) * 100)); // if all disabled, show all
      splitInstance.setSizes(normalizedSizes);
    }

    const paneStates = {
      "1": [true, false, false],
      "2": [false, true, false],
      "3": [false, false, true],
      "a": [true, true, true],
    };

    document.addEventListener("keydown", (event) => {
      if ((event.metaKey || event.ctrlKey) && event.key in paneStates) {
        store.set('webviewOAIEnabled', paneStates[event.key][0]);
        store.set('webviewBARDEnabled', paneStates[event.key][1]);
        store.set('webviewCLAUDEEnabled', paneStates[event.key][2]);

        updateSplitSizes();
        event.preventDefault();
      } else if ((event.metaKey || event.ctrlKey) && event.key === '+' || event.key === '=') {
        webviewOAI.setZoomLevel(webviewOAI.getZoomLevel() + 1);
        webviewBARD.setZoomLevel(webviewBARD.getZoomLevel() + 1);
        webviewCLAUDE.setZoomLevel(webviewCLAUDE.getZoomLevel() + 1);
      } else if ((event.metaKey || event.ctrlKey) && event.key === '-') {
        webviewOAI.setZoomLevel(webviewOAI.getZoomLevel() - 1);
        webviewBARD.setZoomLevel(webviewBARD.getZoomLevel() - 1);
        webviewCLAUDE.setZoomLevel(webviewCLAUDE.getZoomLevel() - 1);
      }

    });


    // fix double-pasting inside webviews
    function setupCustomPasteBehavior(webview) {
      webview.addEventListener('dom-ready', function () {
        webview.executeJavaScript(`
    document.addEventListener('paste', (event) => {
              event.preventDefault();
      let text = event.clipboardData.getData('text');
      let activeElement = document.activeElement;
      let start = activeElement.selectionStart;
      let end = activeElement.selectionEnd;
      activeElement.value = activeElement.value.slice(0, start) + text + activeElement.value.slice(end);
      activeElement.selectionStart = activeElement.selectionEnd = start + text.length;
      });
    `);
      });
    }

    setupCustomPasteBehavior(webviewOAI);
    setupCustomPasteBehavior(webviewBARD);
    setupCustomPasteBehavior(webviewCLAUDE);


  </script>
</body>

</html>